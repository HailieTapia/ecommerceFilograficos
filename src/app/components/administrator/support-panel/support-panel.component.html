<div class="w-full p-4">
  <!-- Sección de Estadísticas -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <!-- Pendientes -->
    <div class="p-6 bg-white rounded-lg shadow">
      <div class="flex items-center gap-4">
        <div class="bg-yellow-100 p-3 rounded-full">
          <i class="fas fa-clock text-yellow-500 text-xl"></i>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-600">Pendientes</h3>
          <p class="text-2xl font-bold mt-1">{{ consultationCounts['pending'] || 0 }}</p>
        </div>
      </div>
    </div>

    <!-- En Proceso -->
    <div class="p-6 bg-white rounded-lg shadow">
      <div class="flex items-center gap-4">
        <div class="bg-blue-100 p-3 rounded-full">
          <i class="fas fa-comments text-blue-500 text-xl"></i>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-600">En Proceso</h3>
          <p class="text-2xl font-bold mt-1">{{ consultationCounts['in_progress'] || 0 }}</p>
        </div>
      </div>
    </div>

    <!-- Resueltos -->
    <div class="p-6 bg-white rounded-lg shadow">
      <div class="flex items-center gap-4">
        <div class="bg-green-100 p-3 rounded-full">
          <i class="fas fa-check-circle text-green-500 text-xl"></i>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-600">Resueltos</h3>
          <p class="text-2xl font-bold mt-1">{{ consultationCounts['resolved'] || 0 }}</p>
        </div>
      </div>
    </div>

    <!-- Cerrados -->
    <div class="p-6 bg-white rounded-lg shadow">
      <div class="flex items-center gap-4">
        <div class="bg-red-100 p-3 rounded-full">
          <i class="fas fa-times-circle text-red-500 text-xl"></i>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-600">Cerrados</h3>
          <p class="text-2xl font-bold mt-1">{{ consultationCounts['closed'] || 0 }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Barra de búsqueda y botón de filtros -->
  <div class="mb-6">
    <div class="flex flex-col md:flex-row gap-4 items-start md:items-center">
      <!-- Barra de búsqueda -->
      <div class="flex-1 relative w-full md:w-3/4">
        <input
          type="text"
          [(ngModel)]="searchQuery"
          (input)="onSearch()"
          placeholder="Buscar tickets por ID, nombre, email o asunto..."
          class="w-full p-2 pl-10 border rounded-md"
        />
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          />
        </svg>
      </div>

      <!-- Botón para mostrar/ocultar filtros -->
      <button
        class="flex items-center gap-2 px-4 py-2 bg-blue-50 text-blue-600 rounded-md hover:bg-blue-100 transition-colors w-full md:w-1/4"
        (click)="toggleFilters()"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-4 h-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"
          />
        </svg>
        {{ showFilters ? 'Ocultar Filtros' : 'Mostrar Filtros' }}
      </button>
    </div>
  </div>

  <!-- Componente de filtrado (condicional) -->
  <app-filters-panel
    *ngIf="showFilters"
    (filtersChanged)="onFiltersChanged($event)"
  ></app-filters-panel>

  <!-- Tabla de Consultas -->
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="p-4 border-b flex justify-between items-center">
      <h2 class="text-lg font-semibold">Tickets de Soporte</h2>
      <div class="flex items-center gap-2">
        <label for="itemsPerPage" class="text-sm text-gray-600">Elementos por página:</label>
        <select
          id="itemsPerPage"
          [(ngModel)]="itemsPerPage"
          (change)="onItemsPerPageChange()"
          class="p-1 border rounded-md text-sm"
        >
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="p-3 text-left text-sm font-medium text-gray-600">ID</th>
            <th class="p-3 text-left text-sm font-medium text-gray-600">Usuario</th>
            <th class="p-3 text-left text-sm font-medium text-gray-600">Asunto</th>
            <th class="p-3 text-left text-sm font-medium text-gray-600">Estado</th>
            <th class="p-3 text-left text-sm font-medium text-gray-600">Fecha Creación</th>
            <th class="p-3 text-left text-sm font-medium text-gray-600">Última Actualización</th>
            <th class="p-3 text-left text-sm font-medium text-gray-600">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          <tr *ngFor="let consultation of consultations" class="hover:bg-gray-50">
            <td class="p-3">#{{ consultation.inquiry_id }}</td>
            <td class="p-3">
              <div class="flex items-center gap-2">
                <i class="fas fa-user text-gray-600"></i>
                <div>
                  <div class="flex items-center gap-1">
                    <p class="font-medium">{{ consultation.user_name }}</p>
                    <div class="relative group">
                      <i
                        [class]="consultation.user_id ? 'fas fa-check-circle text-green-500 cursor-pointer' : ''"
                        class="text-sm"
                      ></i>
                      <div
                        *ngIf="consultation.user_id"
                        class="absolute left-0 -bottom-8 bg-gray-700 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-normal sm:whitespace-nowrap"
                      >
                        Este usuario está registrado en la aplicación
                      </div>
                    </div>
                  </div>
                  <p class="text-sm text-gray-500">{{ consultation.user_email }}</p>
                </div>
              </div>
            </td>
            <td class="p-3">{{ consultation.subject }}</td>
            <td class="p-3">
              <span [class]="getStatusClass(consultation.status)">
                {{ getStatusText(consultation.status) }}
              </span>
            </td>
            <td class="p-3 text-sm">{{ getFormattedDate(consultation.created_at) }}</td>
            <td class="p-3 text-sm">{{ getFormattedDate(consultation.updated_at, true) }}</td>
            <td class="p-3">
              <div *ngIf="editingState[consultation.inquiry_id]?.isEditing; else viewMode">
                <div class="bg-gray-50 p-4 rounded-lg space-y-4 border">
                  <!-- Sección de Estado -->
                  <div>
                    <div class="flex items-center gap-2 mb-2">
                      <label class="text-sm font-medium text-gray-700">Estado del Ticket</label>
                      <div class="relative group">
                        <i class="fas fa-info-circle text-gray-400 cursor-pointer"></i>
                        <div class="absolute left-0 -bottom-8 bg-gray-700 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                          Selecciona el nuevo estado del ticket
                        </div>
                      </div>
                    </div>
                    <select [(ngModel)]="editingState[consultation.inquiry_id].editState.status" class="w-full p-2 border rounded">
                      <option value="pending">Pendiente</option>
                      <option value="in_progress">En Proceso</option>
                      <option value="resolved">Resuelto</option>
                      <option value="closed">Cerrado</option>
                    </select>
                  </div>
                  
                  <!-- Sección de Canal de Respuesta -->
                  <div>
                    <div class="flex items-center gap-2 mb-2">
                      <label class="text-sm font-medium text-gray-700">Canal de Respuesta</label>
                      <div class="relative group">
                        <i class="fas fa-info-circle text-gray-400 cursor-pointer"></i>
                        <div class="absolute left-0 -bottom-8 bg-gray-700 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                          Selecciona el canal por donde se responderá al usuario
                        </div>
                      </div>
                    </div>
                    <select [(ngModel)]="editingState[consultation.inquiry_id].editState.response_channel" class="w-full p-2 border rounded">
                      <option value="email">Correo</option>
                      <option value="whatsapp">WhatsApp</option>
                      <option value="phone">Teléfono</option>
                    </select>
                  </div>
                  
                  <!-- Botones de Acción -->
                  <div class="flex gap-2 pt-2">
                    <button (click)="handleSave(consultation.inquiry_id)" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">
                      Guardar Cambios
                    </button>
                    <button (click)="editingState[consultation.inquiry_id].isEditing = false" class="bg-gray-200 px-3 py-1 rounded text-sm">
                      Cancelar
                    </button>
                  </div>
                  
                  <!-- Mensajes de error -->
                  <div *ngIf="editingState[consultation.inquiry_id]?.errorMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <span class="block sm:inline">{{ editingState[consultation.inquiry_id].errorMessage }}</span>
                    <button (click)="editingState[consultation.inquiry_id].errorMessage = ''" class="absolute top-0 bottom-0 right-0 px-4 py-3">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
              <ng-template #viewMode>
                <div class="flex gap-2 items-center">
                  <button (click)="openModal(consultation.inquiry_id)"
                    class="group text-light-secondary hover:text-light-secondary-hover dark:text-dark-secondary dark:hover:text-dark-secondary-hover transition-all duration-300 relative">
                    <i class="fas fa-eye"></i>
                    <span
                      class="absolute hidden group-hover:block bg-gray-800 dark:bg-gray-900 text-white dark:text-dark-text text-xs rounded-lg px-2 py-1 -top-8 left-1/2 transform -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">Ver</span>
                  </button>
                  <button (click)="handleEdit(consultation.inquiry_id)"
                    class="group text-light-primary dark:text-dark-primary hover:text-light-primary-hover dark:hover:text-dark-primary-hover transition-all duration-300 relative">
                    <i class="fas fa-edit"></i>
                    <span
                      class="absolute hidden group-hover:block bg-gray-800 dark:bg-gray-900 text-white dark:text-dark-text text-xs rounded-lg px-2 py-1 -top-8 left-1/2 transform -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">Editar</span>
                  </button>
                </div>
              </ng-template>
            </td>
          </tr>
        </tbody>
      </table>
      <app-pagination
        [currentPage]="currentPage"
        [totalItems]="totalItems"
        [itemsPerPage]="itemsPerPage"
        (pageChange)="onPageChange($event)"
        class="mt-4 p-4 border-t"
      ></app-pagination>
    </div>
  </div>

  <!-- Modal -->
  <div *ngIf="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center p-4 border-b sticky top-0 bg-white z-10">
        <h2 class="text-xl font-bold">Detalles de la Consulta</h2>
        <button (click)="closeModal()" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="p-4 max-w-3xl mx-auto">
        <div class="border-b">
          <div class="flex justify-between items-start">
            <div>
              <h2 class="text-2xl font-bold mb-2">{{ consultation?.subject }}</h2>
              <p class="text-sm text-gray-500">Ticket #{{ consultation?.inquiry_id }}</p>
            </div>
            <span [class]="getStatusClass(consultation?.status)">
              {{ getStatusText(consultation?.status) }}
            </span>
        </div>
        </div>
        
        <div class="pt-6">
          <div class="grid gap-6">
            <!-- Información del Usuario -->
            <section class="bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-user"></i>
                Información del Usuario
                <div class="relative group" *ngIf="consultation?.user_id">
                  <i class="fas fa-check-circle text-green-500 text-sm cursor-pointer"></i>
                  <div class="absolute left-0 -bottom-8 bg-gray-700 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-normal sm:whitespace-nowrap">
                    Este usuario está registrado en la aplicación
                  </div>
                </div>
              </h3>
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <p class="text-sm text-gray-500">Nombre</p>
                  <p class="font-medium">{{ consultation?.user_name }}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500">Correo Electrónico</p>
                  <p class="font-medium">{{ consultation?.user_email }}</p>
                </div>
              </div>
            </section>
      
            <!-- Detalles del Mensaje -->
            <section class="border-t pt-6">
              <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-comment"></i>
                Mensaje
              </h3>
              <p class="whitespace-pre-wrap bg-white p-4 rounded-lg border">
                {{ consultation?.message }}
              </p>
            </section>
      
            <!-- Información de Contacto -->
            <section class="border-t pt-6">
              <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-envelope"></i>
                Canales de Comunicación
              </h3>
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <p class="text-sm text-gray-500">Canal de Contacto</p>
                  <p class="font-medium capitalize">{{ consultation?.contact_channel }}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500">Canal de Respuesta</p>
                  <p class="font-medium capitalize">{{ consultation?.response_channel }}</p>
                </div>
              </div>
            </section>
      
            <!-- Información Temporal -->
            <section class="border-t pt-6">
              <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-clock"></i>
                Registro Temporal
              </h3>
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <p class="text-sm text-gray-500">Creado</p>
                  <p class="font-medium">{{ getFormattedDate(consultation?.created_at) }}</p>
                </div>
                <div>
                  <p class="text-sm text-gray-500">Última Actualización</p>
                  <p class="font-medium">{{ getFormattedDate(consultation?.updated_at, true) }}</p>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>