<div class="bg-white dark:bg-gray-800 p-3 sm:p-4 md:p-6 rounded-lg shadow-sm mb-4 sm:mb-6 border border-gray-200 dark:border-gray-700">
    <h2 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Filtros de Historial</h2>
    <form [formGroup]="historyFilterForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-2 sm:gap-4 items-end">
        <div>
            <label for="badgeId" class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-100 mb-2">
                Insignia:
            </label>
            <select
                id="badgeId"
                formControlName="badgeId"
                class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md
                    focus:outline-none focus:ring-2 focus:ring-light-primary dark:focus:ring-dark-primary focus:border-transparent text-xs sm:text-sm"
                [ngClass]="{'border-red-500 dark:border-red-400': historyFilterForm.get('badgeId')?.touched && historyFilterForm.get('badgeId')?.invalid}"
            >
                <option value="">Todas las insignias</option>
                <option *ngFor="let badge of badgeOptions" [value]="badge.badge_id">{{ badge.badge_name }}</option>
            </select>
            <div *ngIf="historyFilterForm.get('badgeId')?.errors?.['invalidId']"
                class="mt-1 text-xs text-red-500 dark:text-red-400">ID inválido.</div>
        </div>
        <div>
            <label for="badgeCategoryId" class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-100 mb-2">Categoría:</label>
            <select
                id="badgeCategoryId"
                formControlName="badgeCategoryId"
                class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-light-primary dark:focus:ring-dark-primary focus:border-transparent text-xs sm:text-sm"
                [ngClass]="{'border-red-500 dark:border-red-400': historyFilterForm.get('badgeCategoryId')?.touched && historyFilterForm.get('badgeCategoryId')?.invalid}"
            >
                <option value="">Todas las categorías</option>
                <option *ngFor="let category of badgeCategories" [value]="category.badge_category_id">{{ category.name }}</option>
            </select>
            <div *ngIf="historyFilterForm.get('badgeCategoryId')?.errors?.['invalidId']" class="mt-1 text-xs text-red-500 dark:text-red-400">Categoría inválida.</div>
        </div>
        <div>
            <label for="startDate" class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-100 mb-2">Fecha Inicio:</label>
            <input
                id="startDate"
                formControlName="startDate"
                type="date"
                class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-light-primary dark:focus:ring-dark-primary focus:border-transparent text-xs sm:text-sm"
            />
        </div>
        <div>
            <label for="endDate" class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-100 mb-2">Fecha Fin:</label>
            <input
                id="endDate"
                formControlName="endDate"
                type="date"
                class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-light-primary dark:focus:ring-dark-primary focus:border-transparent text-xs sm:text-sm"
            />
        </div>
        <div>
            <label for="historySort" class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-100 mb-2">Ordenar por:</label>
            <select
                id="historySort"
                [(ngModel)]="historySort"
                (change)="onHistorySortChange()"
                [ngModelOptions]="{standalone: true}"
                class="w-full p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-light-primary dark:focus:ring-dark-primary focus:border-transparent text-xs sm:text-sm"
            >
                <option value="obtained_at:DESC">Más Reciente (Última insignia)</option>
                <option value="obtained_at:ASC">Más Antiguo (Última insignia)</option>
            </select>
        </div>
    </form>
</div>

<div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden border border-gray-200 dark:border-gray-700">
    <div class="p-3 sm:p-4 border-b border-gray-200 dark:border-gray-600 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-4">
        <h2 class="text-base sm:text-lg font-semibold text-gray-900 dark:text-gray-100">Historial por Usuario ({{ totalHistoryItems }} usuarios)</h2>
        <div class="flex items-center gap-2 w-full sm:w-auto">
            <label for="historyItemsPerPage" class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 whitespace-nowrap">Usuarios por página:</label>
            <select
                id="historyItemsPerPage"
                [(ngModel)]="historyItemsPerPage"
                (change)="onHistoryItemsPerPageChange()"
                [ngModelOptions]="{standalone: true}"
                class="w-full sm:w-20 md:w-24 p-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md focus:outline-none focus:ring-2 focus:ring-light-primary dark:focus:ring-dark-primary focus:border-transparent text-xs sm:text-sm"
            >
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
            </select>
        </div>
    </div>
    <div class="p-3 sm:p-4 space-y-4">
        <div *ngIf="historyList.length === 0 && !isLoadingHistory" class="text-center text-xs sm:text-sm text-gray-500 dark:text-gray-400">
            <i class="fas fa-file-alt w-6 sm:w-8 h-6 sm:h-8 mx-auto mb-2 opacity-50"></i>
            <p>No se encontraron registros de historial para los filtros aplicados.</p>
        </div>
        <div *ngIf="isLoadingHistory" class="text-center text-xs sm:text-sm text-gray-500 dark:text-gray-400">
            <i class="fas fa-spinner animate-spin w-6 sm:w-8 h-6 sm:h-8 mx-auto mb-2"></i>
            <p>Cargando historial...</p>
        </div>
        <div *ngFor="let user of historyList" class="bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600 transition-all duration-300">
            <div 
                class="p-3 sm:p-4 flex justify-between items-center cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600"
                (click)="toggleUserExpansion(user.user_id)"
            >
                <div class="flex items-center gap-3 sm:gap-4">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-600 dark:bg-gray-600 rounded-full flex items-center justify-center text-white dark:text-gray-300 font-semibold text-sm sm:text-base">
                        {{ user.user_name ? user.user_name.charAt(0).toUpperCase() : 'U' }}
                    </div>
                    <div>
                        <p class="text-sm sm:text-base font-medium text-gray-900 dark:text-gray-100">
                            {{ user.user_name || 'Usuario' }} (ID: {{ user.user_id }})
                            <span class="text-xs bg-light-primary/10 dark:bg-dark-primary/20 text-light-primary dark:text-dark-primary px-2 py-0.5 rounded ml-2">
                                {{ user.total_badges }} Insignia(s)
                            </span>
                        </p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">
                            {{ user.user_email || 'Sin email' }}
                            <span *ngIf="user.last_obtained_at" class="ml-3">| Última: {{ formatDateTime(user.last_obtained_at) }}</span>
                        </p>
                    </div>
                </div>
                <i class="fas fa-chevron-down transition-transform duration-300" [ngClass]="{'rotate-180': expandedUserId === user.user_id}"></i>
            </div>
            <div *ngIf="expandedUserId === user.user_id" class="p-3 sm:p-4 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-600">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4 badge-grid justify-items-center">
                    <div *ngFor="let badge of user.badges" class="flex items-center gap-3 sm:gap-4 p-3 bg-white dark:bg-gray-700 rounded-xl border border-gray-200 dark:border-gray-600 badge-item w-full max-w-xs shadow-sm hover:shadow-md transition-all">
                        <div class="relative">
                            <img [src]="badge.icon_url" [alt]="badge.badge_name" class="w-10 h-10 sm:w-12 sm:h-12 object-cover rounded-full border-4 border-white shadow-lg">
                            <span class="absolute -top-1 -right-1 bg-blue-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center">✓</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-900 dark:text-gray-100 truncate">{{ badge.badge_name }}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs px-2 py-0.5 bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-200 rounded-full font-medium">{{ badge.badge_category || '-' }}</span>
                                <span class="text-xs text-gray-500 dark:text-gray-400">{{ formatDateTime(badge.obtained_at) }}</span>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="user.badges.length === 0" class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 col-span-full text-center">
                        No hay insignias otorgadas para este usuario con los filtros aplicados.
                    </div>
                </div>
            </div>
        </div>
    </div>
    <app-pagination
        [currentPage]="historyCurrentPage"
        [totalItems]="totalHistoryItems"
        [itemsPerPage]="historyItemsPerPage"
        (pageChange)="onHistoryPageChange($event)"
        class="mt-4 p-3 sm:p-4 border-t border-gray-200 dark:border-gray-700"
    ></app-pagination>
</div>