<div class="py-10 px-5 bg-light-background dark:bg-dark-background min-h-screen font-sans w-full">
  <div *ngIf="isLoading" class="flex justify-center items-center min-h-[50vh]">
    <app-spinner [isLoading]="isLoading"></app-spinner>
  </div>

  <div *ngIf="!isLoading && product" class="max-w-5xl mx-auto">
    <!-- Breadcrumbs -->
    <nav class="mb-6 text-sm text-light-secondary dark:text-dark-secondary">
      <a routerLink="/collection" class="hover:underline">Catálogo</a>
      <span *ngFor="let crumb of breadcrumb; let last = last" class="mx-2">
        <span *ngIf="!last">/</span>
        <a *ngIf="crumb.id" [routerLink]="['/collection', crumb.id]" class="hover:underline">{{ crumb.name }}</a>
        <span *ngIf="!crumb.id">{{ crumb.name }}</span>
      </span>
    </nav>

    <div class="flex flex-col md:flex-row gap-8">
      <!-- Imagen principal y galería -->
      <div class="md:w-1/2">
        <img [src]="selectedImage || 'https://via.placeholder.com/500x500?text=Sin+Imagen'"
             alt="{{ product.name }}" class="w-full h-auto object-cover rounded-lg shadow-md mb-4">
        <div *ngIf="selectedVariant" class="flex gap-2 overflow-x-auto">
          <img *ngFor="let image of selectedVariant.images" [src]="image.image_url"
               (click)="changeImage(image.image_url)" class="w-16 h-16 object-cover rounded-md cursor-pointer"
               [class.border-2]="selectedImage === image.image_url" [class.border-light-primary]="selectedImage === image.image_url">
        </div>
        <div *ngIf="selectedVariant" class="flex justify-between mt-2">
          <button (click)="prevImage()" [disabled]="currentImageIndex === 0" class="text-light-primary dark:text-dark-primary">
            Anterior
          </button>
          <button (click)="nextImage()" [disabled]="!selectedVariant.images || currentImageIndex >= selectedVariant.images.length - 1" class="text-light-primary dark:text-dark-primary">
            Siguiente
          </button>
        </div>
      </div>

      <!-- Detalles del producto -->
      <div class="md:w-1/2">
        <h1 class="text-3xl font-bold text-light-text dark:text-dark-text mb-4">{{ product.name || 'Producto sin nombre' }}</h1>
        <p *ngIf="isAuthenticated && userRole === 'cliente' && product.collaborator" 
           class="text-sm text-light-secondary dark:text-dark-secondary mb-2">
          Vendido por: {{ product.collaborator.name || 'Tienda Oficial' }}
        </p>
        <p class="text-lg font-semibold text-light-text dark:text-dark-text mb-2">
          ${{ formatPrice((selectedVariant?.calculated_price || 0) + (isUrgent && product.urgent_delivery_enabled ? product.urgent_delivery_cost : 0)) }}
        </p>
        <p class="text-sm text-light-secondary dark:text-dark-secondary mb-2">
          Stock: {{ selectedVariant?.stock ?? 0 }}
          <span *ngIf="!(selectedVariant?.stock)" class="text-red-500">Producto agotado</span>
        </p>
        <p class="text-sm text-light-secondary dark:text-dark-secondary mb-4">
          Categoría: {{ product.category?.name || 'Sin categoría' }}
        </p>

        <!-- Variantes -->
        <div class="mb-4">
          <label class="block text-sm font-medium text-light-text dark:text-dark-text mb-1">Seleccionar modelo</label>
          <select [(ngModel)]="selectedVariant" (ngModelChange)="selectVariant($event)"
                  class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-light-text dark:text-dark-text">
            <option *ngFor="let variant of product.variants" [ngValue]="variant">{{ variant.sku || 'Variante ' + variant.variant_id }}</option>
          </select>
        </div>

        <!-- Cantidad -->
        <div class="mb-4" *ngIf="isAuthenticated && userRole === 'cliente' && selectedVariant">
          <label class="block text-sm font-medium text-light-text dark:text-dark-text mb-1">Cantidad</label>
          <div class="flex items-center gap-2">
            <button (click)="decrementQuantity()" [disabled]="quantity <= 1"
                    class="bg-gray-200 dark:bg-gray-600 text-light-text dark:text-dark-text w-8 h-8 rounded-full">-</button>
            <input [(ngModel)]="quantity" type="number" min="1" [max]="selectedVariant.stock ?? 0"
                   class="w-16 p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-light-text dark:text-dark-text text-center">
            <button (click)="incrementQuantity()" [disabled]="quantity >= (selectedVariant.stock ?? 0)"
                    class="bg-gray-200 dark:bg-gray-600 text-light-text dark:text-dark-text w-8 h-8 rounded-full">+</button>
          </div>
          <p class="text-sm text-light-secondary dark:text-dark-secondary mt-1">
            (Máximo disponible: {{ selectedVariant.stock ?? 0 }})
          </p>
        </div>

        <!-- Opciones de entrega -->
        <div class="mb-4" *ngIf="isAuthenticated && userRole === 'cliente'">
          <label class="block text-sm font-medium text-light-text dark:text-dark-text mb-1">Opciones de entrega</label>
          <div class="flex flex-col gap-2">
            <label class="flex items-center gap-2">
              <input type="radio" [(ngModel)]="isUrgent" [value]="false" (change)="applyFilters()"
                     class="text-light-primary dark:text-dark-primary">
              Estándar: {{ product.standard_delivery_days || 0 }} días naturales
            </label>
            <label class="flex items-center gap-2" *ngIf="product.urgent_delivery_enabled">
              <input type="radio" [(ngModel)]="isUrgent" [value]="true" (change)="applyFilters()"
                     class="text-light-primary dark:text-dark-primary">
              Urgente: {{ product.urgent_delivery_days || 0 }} días naturales, +${{ formatPrice(product.urgent_delivery_cost || 0) }}
            </label>
          </div>
          <p class="text-sm text-light-secondary dark:text-dark-secondary mt-2">
            Nota: El tiempo de entrega final se calculará en el carrito según todos los productos. En el checkout, elegirás entre entrega a domicilio, punto de entrega, o retiro en local.
          </p>
        </div>

        <!-- Botones de acción -->
        <div class="flex gap-4 mb-4" *ngIf="isAuthenticated && userRole === 'cliente' && selectedVariant">
          <button (click)="addToCart()" [disabled]="isAddingToCart || selectedVariant.stock == null || selectedVariant.stock === 0"
                  class="bg-light-primary dark:bg-dark-primary text-white font-semibold py-3 px-6 rounded-full hover:bg-light-primary-hover dark:hover:bg-dark-primary-hover transition-colors duration-300">
            Añadir al carrito
          </button>
          <button (click)="buyNow()" [disabled]="isAddingToCart || selectedVariant.stock == null || selectedVariant.stock === 0"
                  class="bg-light-secondary dark:bg-dark-secondary text-white font-semibold py-3 px-6 rounded-full hover:bg-light-secondary-hover dark:hover:bg-dark-secondary-hover transition-colors duration-300">
            Comprar ahora
          </button>
        </div>

        <!-- Compartir -->
        <div class="flex gap-4 mb-4">
          <button (click)="shareOnWhatsApp()" class="flex items-center gap-2 text-light-primary dark:text-dark-primary">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.198-.347.223-.644.075-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.134.297-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.074-.149-.669-.816-.916-1.115-.247-.297-.495-.297-.669-.198-.173.099-1.04.496-1.238.695-.198.198-.297.595-.297.892s.43 1.736.644 2.083c.214.347 1.336 2.158 3.245 3.026.495.223.892.421 1.238.595.347.173.669.322.892.421.223.099.446.099.595.05.149-.05.595-.347.842-.545.247-.198.495-.595.595-.793.099-.198.099-.347 0-.446-.025-.025-.223-.173-.347-.297zm-5.097-9.182c-4.485 0-8.121 3.636-8.121 8.121 0 1.487.404 2.888 1.108 4.094l-.872 3.198 3.274-.865c1.168.637 2.489.998 3.851.998 4.485 0 8.121-3.636 8.121-8.121s-3.636-8.121-8.121-8.121zm0 17.615c-1.406 0-2.762-.374-3.95-1.077l-.284-.149-1.941.514.524-1.917-.149-.284c-.752-1.406-1.148-3.026-1.148-4.708 0-5.094 4.142-9.236 9.236-9.236s9.236 4.142 9.236 9.236-4.142 9.236-9.236 9.236z"/></svg>
            Compartir en WhatsApp
          </button>
          <button (click)="copyLink()" class="flex items-center gap-2 text-light-primary dark:text-dark-primary">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
            Copiar enlace
          </button>
        </div>

        <!-- Descripción -->
        <div class="mb-4">
          <h3 class="text-lg font-semibold text-light-text dark:text-dark-text mb-2">Descripción</h3>
          <p class="text-sm text-light-secondary dark:text-dark-secondary">
            {{ showFullDescription ? product.description : (product.description | slice:0:200) || 'Sin descripción disponible.' }}
            <a *ngIf="product.description && product.description.length > 200" (click)="showFullDescription = !showFullDescription"
               class="text-light-primary dark:text-dark-primary hover:underline cursor-pointer">
              {{ showFullDescription ? 'Ver menos' : 'Ver más' }}
            </a>
          </p>
        </div>

        <!-- Características -->
        <div class="mb-4" *ngIf="selectedVariant">
          <h3 class="text-lg font-semibold text-light-text dark:text-dark-text mb-2">Características</h3>
          <ul class="list-disc list-inside text-sm text-light-secondary dark:text-dark-secondary">
            <li *ngFor="let attr of (showFullAttributes ? selectedVariant.attributes : selectedVariant.attributes?.slice(0, 3))">
              {{ attr?.attribute_name }}: {{ attr?.value }}
            </li>
          </ul>
          <a *ngIf="selectedVariant.attributes && selectedVariant.attributes.length > 3" (click)="showFullAttributes = !showFullAttributes"
             class="text-light-primary dark:text-dark-primary hover:underline cursor-pointer">
            {{ showFullAttributes ? 'Ver menos' : 'Ver más' }}
          </a>
        </div>

        <!-- Personalización -->
        <div class="mb-4" *ngIf="isAuthenticated && userRole === 'cliente' && product.customizations.length > 0">
          <h3 class="text-lg font-semibold text-light-text dark:text-dark-text mb-2">Personalización</h3>
          <select [(ngModel)]="selectedCustomization" (ngModelChange)="selectCustomization($event)"
                  class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-light-text dark:text-dark-text">
            <option [ngValue]="null">Sin personalización</option>
            <option *ngFor="let cust of product.customizations" [ngValue]="cust">{{ cust.type }}: {{ cust.description }}</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>